name: ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ² ğŸ§¹

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Ğ ĞµĞ¶Ğ¸Ğ¼ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (true=Ğ»Ğ¾Ğ³Ğ¸, false=ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ)'
        required: false
        default: 'true'
      keep_last:
        description: 'ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼Ñ‹Ñ… Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ²'
        required: false
        default: '3'
      max_days:
        description: 'Ğ£Ğ´Ğ°Ğ»ÑÑ‚ÑŒ ÑÑ‚Ğ°Ñ€ÑˆĞµ X Ğ´Ğ½ĞµĞ¹ (0=Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ)'
        required: false
        default: '7'
      exclude_branches:
        description: 'Ğ’ĞµÑ‚ĞºĞ¸ Ğ´Ğ»Ñ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ (Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ)'
        required: false

  schedule:
    - cron: "0 4 * * *" # 07:00 ĞœĞ¡Ğš

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      LIMIT: 100

    steps:
      # â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€
      # ğŸ› ï¸ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
      # â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€
      - name: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
        run: |
          echo "â–›â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–œ"
          echo "â–Œ Ğ—Ğ°Ğ¿ÑƒÑĞº: $(date +'%Y-%m-%d %H:%M') ĞœĞ¡Ğš"
          echo "â–Œ Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹: ${{ github.repository }}"
          echo "â–Œ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:"
          echo "â–Œ â€¢ Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼: ${{ inputs.dry_run }}"
          echo "â–Œ â€¢ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ…: ${{ inputs.keep_last }}"
          echo "â–Œ â€¢ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€ÑˆĞµ: ${{ inputs.max_days }} Ğ´Ğ½ĞµĞ¹"
          echo "â–Œ â€¢ Ğ˜ÑĞºĞ»ÑÑ‡Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ²ĞµÑ‚ĞºĞ¸: ${{ inputs.exclude_branches }}"
          echo "â–™â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–Ÿ"

      # â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€
      # ğŸ—‘ï¸ ĞĞ¡ĞĞĞ’ĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ
      # â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€
      - name: ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ğ Ğ°ÑÑÑ‡Ñ‘Ñ‚ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹
          if [ "${{ inputs.max_days }}" = "0" ]; then
           cutoff_date="1970-01-01T00:00:00Z"
          else
           cutoff_date=$(date -d "${{ inputs.max_days }} days ago" +"%Y-%m-%dT%H:%M:%SZ")
          fi

          # ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… workflow
          gh api repos/${{ github.repository }}/actions/workflows | jq -r '.workflows[] | "\(.id)|\(.name)"' | while IFS='|' read -r wf_id wf_name; do
            
            echo "â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€"
            echo " ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°: $wf_name"
            echo "â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘"

            # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ²
            runs=$(gh api "repos/${{ github.repository }}/actions/workflows/$wf_id/runs?per_page=$LIMIT" | jq -r \
             --arg cutoff "$cutoff_date" \
             --arg exclude "${{ inputs.exclude_branches }}" \
             '.workflow_runs[] | select(
               .status != "in_progress" and 
               (.created_at < $cutoff or $cutoff == "1970-01-01T00:00:00Z") and 
               (($exclude == "") or (.branch | inside($exclude | split(",") | map(trim)) | not))
             ) | "\(.id)|\(.status)|\(.created_at)|\(.branch)|\(.head_commit.message)"')
            # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€ĞºĞ°
            sorted_runs=$(echo "$runs" | sort -t'|' -k3 -r)
            to_delete=$(echo "$sorted_runs" | tail -n +$((${{ inputs.keep_last }} + 1)))

            if [ -n "$to_delete" ]; then
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:"
              echo " â”œ Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ²: $(echo "$sorted_runs" | wc -l)"
              echo " â”œ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼: ${{ inputs.keep_last }}"
              echo " â”” Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼: $(echo "$to_delete" | wc -l)"
              echo "â•˜â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

              echo "$to_delete" | while IFS='|' read -r run_id status created_at branch commit_msg; do
                human_date=$(date -d "$created_at" +"%Y-%m-%d %H:%M")
                echo " â”Œ ID: $run_id"
                echo " â”œ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: $status"
                echo " â”œ Ğ’ĞµÑ‚ĞºĞ°: ${branch:-main}"
                echo " â”œ Ğ”Ğ°Ñ‚Ğ°: $human_date"
                echo " â”” ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${commit_msg:0:50}..."
                
                # Ğ ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ
                if [ "${{ inputs.dry_run }}" = "false" ]; then
                  gh api -X DELETE "repos/${{ github.repository }}/actions/runs/$run_id"
                fi
              done
            else
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo " âœ… ĞĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ² Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ"
              echo "â•˜â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            fi
            echo "â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
          done

      # â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€
      # ğŸ“… Ğ˜Ğ¢ĞĞ“Ğ˜
      # â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€
      - name: Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
        if: always()
        run: |
          echo "â–›â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–œ"
          echo "â–Œ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾: $(date +'%Y-%m-%d %H:%M') ĞœĞ¡Ğš"
          echo "â–Œ ĞÑ‚Ñ‡Ñ‘Ñ‚: https://github.com/${{ github.repository }}/actions"
          echo "â–™â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–Ÿ"
